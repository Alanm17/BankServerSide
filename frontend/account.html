<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Details - BankServer</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <a href="dashboard.html" class="navbar-brand">BankServer</a>
        <div class="nav-links">
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 class="card-title" style="margin-bottom: 0.5rem;">Account Details</h2>
                    <p id="accountNumber" style="color: var(--text-secondary); margin: 0;"></p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Current Balance</div>
                    <div id="balance" style="font-size: 2rem; font-weight: 700; color: var(--accent-color);">$0.00</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">Transaction History</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <!-- Transactions loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        &copy; Java Class Project.
    </footer>

    <script src="js/config.js"></script>
    <script>
        // Auth Check
        const userId = localStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            window.location.href = 'index.html';
        }

        // Get accountId from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const accountId = urlParams.get('id');

        if (!accountId) {
            window.location.href = 'dashboard.html';
        }

        async function loadData() {
            try {
                // Load Transactions
                const txResponse = await fetch(`${API_BASE_URL}/api/transactions/${accountId}`);
                const transactions = await txResponse.json();

                // Load Transfers
                const trResponse = await fetch(`${API_BASE_URL}/api/transfers/${accountId}`);
                const transfers = await trResponse.json();

                // Combine and sort
                const allHistory = [
                    ...transactions.map(t => ({ ...t, isTransfer: false })),
                    ...transfers.map(t => ({ ...t, isTransfer: true, type: 'Transfer' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date)); // Note: Date field might be null in current API, need to fix API later for dates

                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = '';

                allHistory.forEach(item => {
                    const row = document.createElement('tr');
                    const isPositive = item.type === 'Deposit' || (item.isTransfer && item.toAccountId == accountId);
                    const amountClass = isPositive ? 'amount-positive' : 'amount-negative';
                    const sign = isPositive ? '+' : '-';

                    // Use transactionDate if available, or fallback
                    const dateStr = item.transactionDate ? new Date(item.transactionDate).toLocaleDateString() : new Date().toLocaleDateString();

                    row.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${item.description || item.type}</td>
                        <td><span style="padding: 4px 8px; background: #e4e6eb; border-radius: 4px; font-size: 0.8rem;">${item.type}</span></td>
                        <td class="${amountClass}">${sign}$${item.amount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Update Balance
                if (userId) {
                    const accResponse = await fetch(`${API_BASE_URL}/api/accounts/user/${userId}`);
                    const accounts = await accResponse.json();
                    const account = accounts.find(a => a.accountId == accountId);
                    if (account) {
                        document.getElementById('balance').innerText = `$${account.balance.toFixed(2)}`;
                        document.getElementById('accountNumber').innerText = `${account.accountType} â€¢ ${account.accountNumber}`;
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        loadData();
    </script>
</body>

</html>